<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Greeting Card</title>
<style>
  :root { --gap: 12px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; background:#f8fafc; color:#0f172a; }
  .wrap { max-width: 900px; margin: 0 auto; }
  .controls { display: grid; gap: var(--gap); grid-template-columns: 1fr 160px 160px; align-items: end; margin: 0 0 12px; }
  .controls label { display: grid; gap: 6px; font-size: 14px; }
  input[type="text"] { padding:10px 12px; border:1px solid #cbd5e1; border-radius: 10px; background:white; }
  button { padding:10px 14px; border:0; border-radius:10px; cursor:pointer; background:#4f46e5; color:white; }
  .secondary { background:#e5e7eb; color:#111827; }
  canvas { width: 100%; height: auto; background: #e2e8f0; border:1px solid #e5e7eb; border-radius: 12px; }
  .row { display:flex; gap: var(--gap); flex-wrap: wrap; margin: 10px 0 18px; }
  small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; word-break: break-all; display:block; }
  .err { color:#b91c1c; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Greeting Card</h1>
  <p>This page uses the image file <strong>card.png</strong> that sits in the <em>same folder</em> as this HTML. No external URLs.</p>

  <div class="controls">
    <label>Your name
      <input id="nameText" type="text" placeholder="Type a name…" />
    </label>
    <button id="renderBtn">Render</button>
    <button class="secondary" id="downloadBtn">Download PNG</button>
  </div>

  <canvas id="cardCanvas"></canvas>
  <p id="status" class="err"></p>

  <div class="row">
    <button class="secondary" id="copyLinkBtn">Copy Share Link</button>
    <div>
      <strong>Current share link:</strong>
      <small class="mono" id="shareUrl">—</small>
    </div>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const nameInput = document.getElementById('nameText');
  const canvas = document.getElementById('cardCanvas');
  const ctx = canvas.getContext('2d');
  const statusEl = document.getElementById('status');

  // Defaults
  const defaults = {
    img: 'card.png',
    color: '#ffffff'
  };

  // Fill name from URL (?name=...)
  nameInput.value = qs.get('name') || '';

  function buildLink() {
    const params = new URLSearchParams();
    const name = nameInput.value.trim();
    if (name) params.set('name', name);
    const url = `${location.origin}${location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
    document.getElementById('shareUrl').textContent = url;
    return url;
  }

  function loadImage(src) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error('Could not load ' + src + '. Make sure card.png is in the same folder (case-sensitive).'));
      img.src = src;
    });
  }

  async function draw() {
    statusEl.textContent = '';
    let img;
    try {
      img = await loadImage(defaults.img);
    } catch (e) {
      statusEl.textContent = e.message;
      return;
    }

    // Prepare canvas to match image size
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // Draw the name text centered near bottom
    const name = (nameInput.value || '').trim();
    if (name) {
      const size = Math.round(Math.min(canvas.width, canvas.height) * 0.12); // adaptive
      const stroke = Math.max(2, Math.round(size * 0.07));
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.font = `700 ${size}px Poppins,Arial,Helvetica,sans-serif`;
      const centerX = canvas.width / 2;
      const baseY = canvas.height * 0.83; // 75% down
      ctx.lineWidth = stroke;
      ctx.strokeStyle = 'rgba(0,0,0,0.65)';
      ctx.strokeText(name, centerX, baseY);
      ctx.fillStyle = defaults.color;
      ctx.fillText(name, centerX, baseY);
      ctx.restore();
    }
    buildLink();
  }

  // Listeners
  document.getElementById('renderBtn').addEventListener('click', draw);
  document.getElementById('downloadBtn').addEventListener('click', () => {
    const a = document.createElement('a');
    a.download = 'greeting.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  });
  document.getElementById('copyLinkBtn').addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(buildLink());
      alert('Link copied');
    } catch {
      alert('Copy failed. Select and copy the link shown.');
    }
  });
  nameInput.addEventListener('input', buildLink);

  // Auto-render on load
  draw();
</script>
</body>
</html>
